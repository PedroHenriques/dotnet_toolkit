# Toolkit for logging with Opentelemetry

## Package
This service is included in the `PJHToolkit` package.

## Requirements
This service expect the following `environment variables` to be configured in your application.

| Name | Required | Description |
| ----------- | ----------- | ----------- |
| `LOG_DESTINATION_URI` | Yes | The `uri` of the otel collector where logs should be sent to. |
| `SERVICE_NAME` | No | The name of the service that will show up in the logs. |
| `SERVICE_VERSION` | No | The version of the service that will show up in the logs. |
| `PROJECT_NAME` | No | The name of the project that will show up in the logs. |
| `DEPLOYMENT_ENV` | No | The environment the application is running in. |
| `LOG_LEVEL` | No | The minimum log level that will generate logs.<br>**NOTE:** Defaults to `warning`. |
| `EXPORTER_MODE` | No | The mode under which the OTEL exporters will function.<br>Supported values:<br>- `batch`: Collect logs and push them asynchronously to the OTEL collector.<br>- `sync`: Push logs to the OTEL collector as soon as they are generated.<br>**NOTE:** Defaults to `batch`. |

## How to use
```c#
using Toolkit;
using Toolkit.Types;

// Setup the logger in a hosted environment
// "builder" is of the type IHostApplicationBuilder
builder = LoggerUtils.PrepareInputs(builder);

// Create a standalone logger
var loggerInputs = LoggerUtils.PrepareInputs("Tester.Program", "Tester", "Main thread");
Toolkit.Types.ILogger logger = new Logger(loggerInputs);
```

In the above snippet we:
- In the first variation:
  - Start by using the `KafkaUtils.PrepareInputs()` utility function to let the Toolkit handle all the necessary setup for interactions with the logger and Opentelemetry.
  - The host's logger will be configured
  - From this point forward when you use the .Net default's ILogger to generate a log it will be in the Opentelemetry standard
- In the second variation:
  - Start by using the `KafkaUtils.PrepareInputs()` utility function to let the Toolkit handle all the necessary setup for interactions with the logger and Opentelemetry
  - An instance of logger inputs is returned
  - Then we instantiate the Toolkit's Logger class
  - Any logs generated by using the Logger class' instance will be in the Opentelemetry standard

The instance of `Toolkit.Types.ILogger` exposes the following functionality:

```c#
public interface ILogger
{
  public IDisposable? BeginScope(IReadOnlyDictionary<string, object?> scope);

  public void Log(
    Microsoft.Extensions.Logging.LogLevel level, Exception? ex,
    string message, params object?[] args
  );

  public static virtual Activity? SetTraceIds(
    string traceId, string activitySourceName, string activityName, string? spanId = null
  );
}
```

### BeginScope
Starts a scope on the logger with the provided information.<br>
The Logger will use the scope information during log generation and this information will be added to the logs in the `Attributes` block of the Opentelemetry log schema.

**Example use**
```c#
logger.BeginScope(
  new Dictionary<string, object?>
  {
    ["scope.prop"] = "test mongo prop",
    ["hello from scope"] = "world from mongo",
  }
);
```

### Log
Generates a log with the provided `level` log level and `message` message.<br>
If an Excpetion is provided in `ex` then the log will contain information extracted from it.<br>
If the log level of the requested log is inferior to the minimum log level defined, then no log will be generated.<br>

**Example use**
```c#
logger.Log(LogLevel.Debug, null, "Tester: some debug message would go here.");
logger.Log(LogLevel.Information, null, "Tester: setup complete.");
logger.Log(LogLevel.Critical, new Exception("Tester: test exception for log"), "Tester: exception logging.");
```

### SetTraceIds
Starts a new Activity with the provided `traceId` trace id, `activitySourceName` activity source name and `activityName` activity name.<br>
If the `spanId` is provided, then the activity will be set with that span id, otherwise a random span id will be used.<br>
**NOTE:** The provided `traceId` and `spanId` must be string representations of valid trace and span ids.<br>
**NOTE:** If the provided `traceId` isn't valid, a random valid Trace ID will be generated and used.<br>
**NOTE:** Any logs generated after calling this method will contain this trace id and span id.<br>
**NOTE:** This method starts a .Net native [Activity](https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.activity), so it is thread safe and scope contained.

**Example use**
```c#
using var activity = Logger.SetTraceIds("4bf92f3577b34da6a3ce929d0e0e4736", "MongoDb Watcher", "Change received", ActivitySpanId.CreateRandom().ToString());

// These 2 logs will contain the trace id and span id provided above
logger.Log(LogLevel.Warning, null, "Received event from Mongo Stream:");
logger.Log(LogLevel.Warning, null, JsonConvert.SerializeObject(change));
```
